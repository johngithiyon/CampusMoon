<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhatsApp-style Discussion</title>
<style>
:root{--accent:#3b6fb0;--muted:#9aa8bd;--bg:#f4f7fb}
*{box-sizing:border-box}
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:#102030}
.app{max-width:600px;margin:24px auto;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 30px rgba(20,30,50,.06)}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,var(--accent),#2f5f9a);color:#fff}
header h1{font-size:18px;margin:0}
header .controls{display:flex;gap:10px;align-items:center}
header input{padding:6px 8px;border-radius:6px;border:none;font-size:14px}
.main{display:flex;flex-direction:column;min-height:540px}
.messages{flex:1;padding:18px;overflow:auto;background:#eef3f9;display:flex;flex-direction:column;gap:8px}
.message{max-width:75%;padding:10px 14px;border-radius:18px;position:relative;box-shadow:0 1px 0 rgba(0,0,0,0.05);word-break:break-word}
.message .meta{font-size:12px;color:var(--muted);margin-bottom:4px}
.message.sent{align-self:flex-end;background:linear-gradient(180deg,var(--accent),#32679c);color:#fff;border-bottom-right-radius:4px}
.message.received{align-self:flex-start;background:#fff;border:1px solid #e4eef9;border-bottom-left-radius:4px}
.message .text{white-space:pre-wrap}
.message .actions{margin-top:6px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
.message .actions button{background:none;border:none;color:var(--accent);cursor:pointer;padding:2px 6px;border-radius:6px}
.controls-row{display:flex;padding:14px;border-top:1px solid #eef3f9;background:#fff;align-items:center;gap:10px}
textarea{flex:1;min-height:44px;max-height:140px;padding:10px;border-radius:10px;border:1px solid #e6eef6;resize:none}
.btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid #e6eef6}
.rec-indicator{display:flex;align-items:center;gap:8px;color:#e84c3d}
.small{font-size:13px;color:var(--muted)}
.reply-preview{background:#f1f7ff;padding:8px;border-left:3px solid var(--accent);margin:8px 18px;border-radius:6px;display:flex;justify-content:space-between;align-items:center}
.hidden{display:none}
.audio-player{display:flex;align-items:center;gap:8px}
.audio-player audio{display:block}
.status{font-size:13px;color:#fff;background:rgba(0,0,0,0.12);padding:4px 8px;border-radius:8px}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Discussion">
<header>
  <h1>Audio Discussion</h1>
  <div class="controls">
    <span class="status" id="connStatus">Disconnected</span>
    <label for="username" class="small" style="margin-left:8px;color:#fff">You:</label>
    <input id="username" placeholder="Enter name" title="Display name" />
  </div>
</header>

<div class="main">
  <div id="messages" class="messages" aria-live="polite" aria-atomic="false"></div>

  <div id="replyPreview" class="reply-preview hidden">
    <div id="replyPreviewText" class="small"></div>
    <button id="cancelReply" class="btn secondary">Cancel</button>
  </div>

  <div class="controls-row">
    <textarea id="textInput" placeholder="Type a message and press Enter to send"></textarea>
    <button id="sendText" class="btn">Send</button>
    <button id="recordBtn" class="btn secondary">Record</button>
  </div>

  <div style="padding:10px 18px;background:#fff;border-top:1px solid #eef3f9">
    <div id="recordStatus" class="rec-indicator hidden"><span id="recDot">●</span><span>Recording...</span><button id="stopRec" class="btn" style="margin-left:12px">Stop</button></div>
  </div>
</div>
</div>

<script>
(function(){
const WS_URL = (location.protocol==='https:'?'wss://':'ws://') + location.host + '/ws_discussion';
const HISTORY_URL = '/discussion/history';

const connStatus = document.getElementById('connStatus');
const messagesEl = document.getElementById('messages');
const usernameEl = document.getElementById('username');
const textInput = document.getElementById('textInput');
const sendTextBtn = document.getElementById('sendText');
const recordBtn = document.getElementById('recordBtn');
const recordStatus = document.getElementById('recordStatus');
const stopRecBtn = document.getElementById('stopRec');
const replyPreview = document.getElementById('replyPreview');
const replyPreviewText = document.getElementById('replyPreviewText');
const cancelReplyBtn = document.getElementById('cancelReply');

let ws=null, isConnected=false, mediaRecorder=null, recording=false, chunks=[], replyToId=null;
let localUser = localStorage.getItem('discussion_username') || ('User'+Math.floor(Math.random()*900+100));
usernameEl.value = localUser;

function setStatus(text,color){ connStatus.textContent=text; connStatus.style.background=color||'transparent'; }
function formatTime(ts){ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

function createMessageElement(msg){
  const wrapper=document.createElement('div');
  wrapper.className='message '+(msg.sender===localUser?'sent':'received');
  const meta=document.createElement('div'); meta.className='meta';
  meta.textContent=msg.sender+' • '+formatTime(msg.timestamp||new Date().toISOString());
  wrapper.appendChild(meta);
  if(msg.type==='text'||!msg.type){ const t=document.createElement('div'); t.className='text'; t.textContent=msg.content; wrapper.appendChild(t); }
  else if(msg.type==='audio'){ const aWrap=document.createElement('div'); aWrap.className='audio-player'; const audio=document.createElement('audio'); audio.controls=true; audio.src=msg.content; aWrap.appendChild(audio); wrapper.appendChild(aWrap); }
  const actions=document.createElement('div'); actions.className='actions';
  const replyBtn=document.createElement('button'); replyBtn.textContent='Reply'; replyBtn.onclick=()=>openReply(msg); actions.appendChild(replyBtn); wrapper.appendChild(actions);
  return wrapper;
}

function openReply(msg){ replyToId=msg.id||null; const preview=(msg.type==='text'?msg.content:'[audio]'); replyPreviewText.textContent=(msg.sender||'Someone')+': '+(preview.length>120?preview.slice(0,120)+'…':preview); replyPreview.classList.remove('hidden'); textInput.focus(); }
function cancelReply(){ replyToId=null; replyPreview.classList.add('hidden'); }
cancelReplyBtn.addEventListener('click',cancelReply);

async function loadHistory(){
  try{
    const res=await fetch(HISTORY_URL,{cache:'no-store'}); if(!res.ok)return;
    const data=await res.json(); messagesEl.innerHTML='';
    data.forEach(msg=>{ const el=createMessageElement(msg); messagesEl.appendChild(el); });
    messagesEl.scrollTop=messagesEl.scrollHeight;
  }catch(e){ console.warn('history load failed',e); }
}

function connectWS(){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>{ isConnected=true; setStatus('Connected','rgba(0,128,0,0.18)'); };
  ws.onmessage=(evt)=>{
    try{
      const msg=JSON.parse(evt.data);
      if(!msg.timestamp) msg.timestamp=new Date().toISOString();
      // Display all messages, including sender
      const el=createMessageElement(msg); messagesEl.appendChild(el);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    }catch(e){ console.warn(e);}
  };
  ws.onclose=()=>{ isConnected=false; setStatus('Disconnected','rgba(128,0,0,0.12)'); setTimeout(connectWS,1500);}
  ws.onerror=e=>console.warn('ws error',e);
}

function sendText(){
  const txt=textInput.value.trim(); if(!txt) return;
  const payload={type:'text',content:txt,reply_to_id:replyToId||null,timestamp:new Date().toISOString(),sender:localUser};
  const el=createMessageElement(payload); messagesEl.appendChild(el); messagesEl.scrollTop=messagesEl.scrollHeight; textInput.value=''; cancelReply();
  if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(payload));
}

async function startRecording(){
  if(recording) return;
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream); chunks=[];
    mediaRecorder.ondataavailable=e=>{ if(e.data && e.data.size) chunks.push(e.data); }
    mediaRecorder.onstop=()=>{
      const blob=new Blob(chunks,{type:chunks[0]?.type||'audio/webm'});
      const localMsg={type:'audio',content:URL.createObjectURL(blob),sender:localUser,timestamp:new Date().toISOString()};
      messagesEl.appendChild(createMessageElement(localMsg));
      messagesEl.scrollTop=messagesEl.scrollHeight;
      if(ws && ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify({type:'audio_meta',reply_to_id:replyToId||null,timestamp:new Date().toISOString(),sender:localUser})); ws.send(blob); }
      stream.getTracks().forEach(t=>t.stop()); recording=false; updateRecordingUI(); cancelReply();
    };
    mediaRecorder.start(); recording=true; updateRecordingUI();
  }catch(e){ alert('Allow microphone access.'); recording=false; updateRecordingUI();}
}
function stopRecording(){ if(recording && mediaRecorder?.state!=='inactive') mediaRecorder.stop(); }
function toggleRecording(){ recording?stopRecording():startRecording(); }
function updateRecordingUI(){ recording?recordStatus.classList.remove('hidden'):recordStatus.classList.add('hidden'); recordBtn.textContent=recording?'Recording…':'Record'; }

sendTextBtn.addEventListener('click',sendText);
textInput.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendText(); }});
recordBtn.addEventListener('click',e=>{ e.preventDefault(); toggleRecording(); });
stopRecBtn?.addEventListener('click',stopRecording);
usernameEl.addEventListener('change',()=>{ localUser=usernameEl.value.trim()||localUser; localStorage.setItem('discussion_username',localUser); });

(function init(){ setStatus('Connecting…','rgba(200,180,0,0.18)'); connectWS(); loadHistory(); updateRecordingUI(); })();
})();
</script>
</body>
</html>
