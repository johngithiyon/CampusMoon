<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-time Polling System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4a6cf7;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --dark-color: #343a40;
      --light-color: #f8f9fa;
      --background-color: #f4f7fe;
      --card-background: #ffffff;
      --border-radius: 12px;
      --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--background-color);
      color: #333;
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
    }

    header h1 {
      color: var(--primary-color);
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    header p {
      color: var(--secondary-color);
      font-size: 1.1rem;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .card {
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--box-shadow);
    }

    .card h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--dark-color);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .card h2 i {
      color: var(--primary-color);
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px;
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--success-color);
    }

    .status-indicator.connecting {
      background-color: var(--warning-color);
    }

    .status-indicator.disconnected {
      background-color: var(--danger-color);
    }

    .participant-count {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--secondary-color);
    }

    .action-buttons {
      display: flex;
      gap: 15px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 50px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: #3a5ad9;
    }

    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background-color: #bd2130;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
      color: var(--dark-color);
    }

    .btn-warning:hover {
      background-color: #e0a800;
    }
    
    .btn-chat {
      background-color: #6f42c1;
      color: white;
    }

    .btn-chat:hover {
      background-color: #5a2d91;
    }

    /* Poll-specific styles */
    .poll-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 500px;
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      display: none;
      flex-direction: column;
      z-index: 1002;
      overflow: hidden;
    }

    .poll-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: white;
    }

    .poll-header h3 {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .poll-content {
      padding: 20px;
    }

    .poll-question {
      margin-bottom: 20px;
    }

    .poll-question input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .poll-options {
      margin-bottom: 20px;
    }

    .poll-option {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .poll-option input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .poll-option button {
      padding: 10px;
      border-radius: 8px;
      background-color: var(--danger-color);
      color: white;
      border: none;
      cursor: pointer;
    }

    .correct-answer-checkbox {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
      font-size: 0.8rem;
      color: var(--secondary-color);
    }

    .add-option {
      display: block;
      width: 100%;
      padding: 10px;
      background-color: #f0f0f0;
      border: 1px dashed #ccc;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .add-option:hover {
      background-color: #e0e0e0;
    }

    .poll-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .active-poll {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 15px;
      z-index: 999;
      display: none;
    }

    .active-poll-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .active-poll-question {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .poll-option-item {
      margin-bottom: 8px;
    }

    .poll-option-button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 8px 12px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .poll-option-button:hover {
      background-color: #e0e0e0;
    }

    .poll-option-button.selected {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .poll-option-button.correct {
      border: 2px solid var(--success-color);
    }

    .poll-option-button.incorrect {
      border: 2px solid var(--danger-color);
    }

    .poll-results {
      margin-top: 15px;
      display: none;
    }

    .poll-result-item {
      margin-bottom: 8px;
    }

    .poll-result-bar {
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      margin-top: 4px;
      overflow: hidden;
    }

    .poll-result-fill {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 4px;
    }

    .poll-result-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-top: 2px;
    }

    .results-container {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    .results-summary {
      margin-bottom: 15px;
      text-align: center;
    }

    .attendance-message {
      margin-top: 15px;
      padding: 10px;
      background-color: var(--success-color);
      color: white;
      border-radius: 6px;
      text-align: center;
    }

    .control-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .control-btn:hover {
      background-color: rgba(0, 0, 0, 0.7);
    }

    .participant-name-input {
      margin-bottom: 20px;
    }

    .participant-name-input input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .attendance-list {
      margin-top: 15px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 8px;
    }

    .attendance-list h4 {
      margin-bottom: 8px;
      color: var(--dark-color);
    }

    .attendance-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #ddd;
    }

    .attendance-item:last-child {
      border-bottom: none;
    }

    .correct-indicator {
      color: var(--success-color);
      font-weight: bold;
    }

    /* New Send Email Button Styles */
    .mail-button {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      z-index: 1003;
    }
    
    .mail-button:hover {
      background-color: #3a5ad9;
      transform: scale(1.05);
    }
    
    .mail-button i {
      font-size: 1.2rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .status-bar {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .action-buttons {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .active-poll {
        width: 250px;
        right: 10px;
        bottom: 10px;
      }
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: 2rem;
      }
      
      .btn {
        padding: 8px 16px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- New Send Email Button -->
  <button class="mail-button" title="Send Email" onclick="window.location.href='http://localhost:8080/email'">
    <i class="fas fa-envelope"></i>
  </button>

  <div class="container">
    <header>
      <h1>Real-time Polling System</h1>
      <p>Create polls and get instant responses from participants</p>
    </header>

    <div class="main-content">
      <div class="card">
        <h2><i class="fas fa-user"></i> Participant Information</h2>
        <div class="participant-name-input">
          <input type="text" id="participantName" placeholder="Enter your name">
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-poll"></i> Poll Management</h2>
        <p>Create a new poll that will be instantly shared with all connected participants.</p>
        <div class="action-buttons">
          <button class="btn btn-primary" id="createPoll">
            <i class="fas fa-plus"></i> Create New Poll
          </button>
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-users"></i> Participants</h2>
        <div id="participantsList">
          <p>No participants yet. Open this page in another tab to test the polling system.</p>
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-chart-bar"></i> Poll Results</h2>
        <div id="resultsContainer" class="results-container">
          <p>No poll results yet. Create a poll to see results here.</p>
        </div>
      </div>

      <div class="status-bar">
        <div class="connection-status">
          <div class="status-indicator" id="connectionStatus"></div>
          <span id="statusText">Connecting...</span>
        </div>
        
        <div class="participant-count">
          <i class="fas fa-users"></i>
          <span id="participantCount">1 participant</span>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-danger" id="resetPoll">
            <i class="fas fa-redo"></i> Reset Poll
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Poll Creation Overlay -->
  <div class="poll-overlay" id="pollOverlay">
    <div class="poll-header">
      <h3><i class="fas fa-poll"></i> Create Poll</h3>
      <button class="control-btn" id="closePoll" title="Close Poll Creator">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="poll-content">
      <div class="poll-question">
        <input type="text" id="pollQuestion" placeholder="Enter your poll question...">
      </div>
      <div class="poll-options" id="pollOptions">
        <div class="poll-option">
          <input type="text" placeholder="Option 1">
          <div class="correct-answer-checkbox">
            <input type="radio" name="correctAnswer" value="0"> Mark as correct answer
          </div>
          <button class="remove-option"><i class="fas fa-times"></i></button>
        </div>
        <div class="poll-option">
          <input type="text" placeholder="Option 2">
          <div class="correct-answer-checkbox">
            <input type="radio" name="correctAnswer" value="1"> Mark as correct answer
          </div>
          <button class="remove-option"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <button class="add-option" id="addPollOption">
        <i class="fas fa-plus"></i> Add Option
      </button>
      <div class="poll-buttons">
        <button class="btn btn-danger" id="cancelPoll">
          Cancel
        </button>
        <button class="btn btn-primary" id="publishPoll">
          Publish Poll
        </button>
      </div>
    </div>
  </div>

  <!-- Active Poll Display -->
  <div class="active-poll" id="activePoll">
    <div class="active-poll-header">
      <h4>Live Poll</h4>
      <button class="control-btn close-poll" title="Close Poll">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="active-poll-question" id="activePollQuestion"></div>
    <div class="poll-options-list" id="pollOptionsList"></div>
    <div class="poll-results" id="pollResults">
      <div class="poll-result-text" id="pollResultText"></div>
    </div>
  </div>

  <script>
    // WebSocket simulation for peer-to-peer communication
    class PollWebSocket {
      constructor() {
        this.listeners = [];
        this.connected = false;
        this.participants = new Map(); // Changed to Map to store participant names
        this.participantId = 'user-' + Math.floor(Math.random() * 10000);
        
        // Simulate connection
        setTimeout(() => {
          this.connected = true;
          this.notifyListeners('open');
          
          // Listen for storage events (simulating communication between tabs)
          window.addEventListener('storage', this.handleStorageEvent.bind(this));
        }, 500);
      }
      
      addEventListener(type, callback) {
        this.listeners.push({ type, callback });
      }
      
      notifyListeners(type, data) {
        this.listeners.forEach(listener => {
          if (listener.type === type) {
            listener.callback(data);
          }
        });
      }
      
      send(data) {
        if (typeof data === 'string') {
          data = JSON.parse(data);
        }
        
        // Store in localStorage to simulate sending to other tabs
        const message = {
          ...data,
          sender: this.participantId,
          timestamp: Date.now()
        };
        
        localStorage.setItem('pollMessage', JSON.stringify(message));
        localStorage.removeItem('pollMessage');
      }
      
      handleStorageEvent(event) {
        if (event.key === 'pollMessage' && event.newValue) {
          const message = JSON.parse(event.newValue);
          if (message.sender !== this.participantId) {
            this.notifyListeners('message', { data: JSON.stringify(message) });
          }
        }
      }
      
      addParticipant(id, name) {
        this.participants.set(id, name);
        this.notifyListeners('participants', Array.from(this.participants));
      }
      
      removeParticipant(id) {
        this.participants.delete(id);
        this.notifyListeners('participants', Array.from(this.participants));
      }
    }

    // DOM elements
    const participantNameInput = document.getElementById("participantName");
    const createPollBtn = document.getElementById("createPoll");
    const pollOverlay = document.getElementById("pollOverlay");
    const closePollBtn = document.getElementById("closePoll");
    const pollQuestion = document.getElementById("pollQuestion");
    const pollOptions = document.getElementById("pollOptions");
    const addPollOptionBtn = document.getElementById("addPollOption");
    const cancelPollBtn = document.getElementById("cancelPoll");
    const publishPollBtn = document.getElementById("publishPoll");
    const activePoll = document.getElementById("activePoll");
    const activePollQuestion = document.getElementById("activePollQuestion");
    const pollOptionsList = document.getElementById("pollOptionsList");
    const pollResults = document.getElementById("pollResults");
    const pollResultText = document.getElementById("pollResultText");
    const connectionStatus = document.getElementById("connectionStatus");
    const statusText = document.getElementById("statusText");
    const participantCount = document.getElementById("participantCount");
    const participantsList = document.getElementById("participantsList");
    const resultsContainer = document.getElementById("resultsContainer");
    const resetPollBtn = document.getElementById("resetPoll");
    
    // Poll state variables
    let currentPoll = null;
    let userVote = null;
    let participants = new Map(); // Changed to Map to store participant names
    let pollResultsData = {};
    let attendanceRecords = {};
    let isPollCreator = false;
    
    // Initialize WebSocket connection
    const ws = new PollWebSocket();
    
    // Set up event listeners
    function setupEventListeners() {
      // Participant name input
      participantNameInput.addEventListener('change', updateParticipantName);
      
      // Poll creation events
      createPollBtn.addEventListener('click', openPollCreator);
      closePollBtn.addEventListener('click', closePollCreator);
      addPollOptionBtn.addEventListener('click', addPollOption);
      cancelPollBtn.addEventListener('click', closePollCreator);
      publishPollBtn.addEventListener('click', publishPoll);
      
      // Close active poll
      activePoll.querySelector('.close-poll').addEventListener('click', closeActivePoll);
      
      // Reset poll
      resetPollBtn.addEventListener('click', resetPoll);
      
      // WebSocket events
      ws.addEventListener('open', () => {
        updateConnectionStatus('connected');
      });
      
      ws.addEventListener('participants', (participantsList) => {
        participants = new Map(participantsList);
        updateParticipantCount();
        updateParticipantsList();
      });
      
      ws.addEventListener('message', (event) => {
        const message = JSON.parse(event.data);
        handleIncomingMessage(message);
      });
    }
    
    // Update participant name
    function updateParticipantName() {
      const name = participantNameInput.value.trim() || 'Anonymous';
      ws.addParticipant(ws.participantId, name);
      
      // Send update to other participants
      ws.send(JSON.stringify({
        type: 'participant-updated',
        participantId: ws.participantId,
        participantName: name
      }));
    }
    
    // Handle incoming WebSocket messages
    function handleIncomingMessage(message) {
      switch(message.type) {
        case "poll-created":
          isPollCreator = message.sender === ws.participantId;
          displayPoll(message.poll);
          break;
          
        case "poll-vote":
          updatePollResults(message.pollId, message.optionIndex, message.sender, message.participantName);
          break;
          
        case "poll-ended":
          endPoll(message.pollId, message.finalResults);
          break;
          
        case "participant-joined":
          ws.addParticipant(message.participantId, message.participantName || 'Anonymous');
          break;
          
        case "participant-updated":
          ws.addParticipant(message.participantId, message.participantName);
          break;
          
        case "attendance-marked":
          updateAttendanceRecords(message.participantId, message.participantName, message.correct);
          break;
      }
    }
    
    // Update connection status indicator
    function updateConnectionStatus(status) {
      connectionStatus.className = 'status-indicator';
      
      switch(status) {
        case 'connected':
          connectionStatus.classList.add('connected');
          statusText.textContent = 'Connected';
          break;
        case 'connecting':
          connectionStatus.classList.add('connecting');
          statusText.textContent = 'Connecting...';
          break;
        case 'disconnected':
          connectionStatus.classList.add('disconnected');
          statusText.textContent = 'Disconnected';
          break;
      }
    }
    
    // Update participant count
    function updateParticipantCount() {
      const count = participants.size;
      participantCount.textContent = `${count} participant${count !== 1 ? 's' : ''}`;
    }
    
    // Update participants list
    function updateParticipantsList() {
      participantsList.innerHTML = '';
      
      if (participants.size === 0) {
        participantsList.innerHTML = '<p>No participants yet. Open this page in another tab to test the polling system.</p>';
        return;
      }
      
      const list = document.createElement('ul');
      participants.forEach((name, id) => {
        const item = document.createElement('li');
        item.textContent = `${name}${id === ws.participantId ? ' (You)' : ''}`;
        list.appendChild(item);
      });
      
      participantsList.appendChild(list);
    }
    
    // Poll functionality
    function openPollCreator() {
      pollOverlay.style.display = 'flex';
      pollQuestion.value = '';
      
      // Clear existing options except the first two
      const options = pollOptions.querySelectorAll('.poll-option');
      for (let i = 2; i < options.length; i++) {
        options[i].remove();
      }
      
      // Reset first two options
      const firstOption = options[0].querySelector('input[type="text"]');
      const secondOption = options[1].querySelector('input[type="text"]');
  
      firstOption.value = '';
      secondOption.value = '';
      firstOption.placeholder = 'Option 1';
      secondOption.placeholder = 'Option 2';
      
      // Reset radio buttons
      document.querySelectorAll('input[name="correctAnswer"]').forEach(radio => {
        radio.checked = false;
      });
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-option').forEach(button => {
        button.addEventListener('click', function() {
          if (pollOptions.querySelectorAll('.poll-option').length > 2) {
            this.parentElement.remove();
          }
        });
      });
    }
    
    function closePollCreator() {
      pollOverlay.style.display = 'none';
    }
    
    function addPollOption() {
      const optionCount = pollOptions.querySelectorAll('.poll-option').length;
      const optionDiv = document.createElement('div');
      optionDiv.className = 'poll-option';
      optionDiv.innerHTML = `
        <input type="text" placeholder="Option ${optionCount + 1}">
        <div class="correct-answer-checkbox">
          <input type="radio" name="correctAnswer" value="${optionCount}"> Mark as correct answer
        </div>
        <button class="remove-option"><i class="fas fa-times"></i></button>
      `;
      pollOptions.appendChild(optionDiv);
      
      // Add event listener to the remove button
      optionDiv.querySelector('.remove-option').addEventListener('click', function() {
        if (pollOptions.querySelectorAll('.poll-option').length > 2) {
          optionDiv.remove();
        }
      });
    }
    
    function publishPoll() {
      const question = pollQuestion.value.trim();
      if (!question) {
        alert('Please enter a poll question');
        return;
      }
      
      const optionInputs = pollOptions.querySelectorAll('input[type="text"]');
      const options = [];
      
      for (let i = 0; i < optionInputs.length; i++) {
        const optionText = optionInputs[i].value.trim();
        if (optionText) {
          options.push(optionText);
        }
      }
      
      if (options.length < 2) {
        alert('Please add at least two options');
        return;
      }
      
      // Get correct answer
      const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
      let correctAnswerIndex = -1;
      
      if (correctAnswerRadio) {
        correctAnswerIndex = parseInt(correctAnswerRadio.value);
      }
      
      // Create poll object
      const pollId = 'poll-' + Date.now();
      const poll = {
        id: pollId,
        question: question,
        options: options,
        correctAnswer: correctAnswerIndex,
        results: {},
        totalVotes: 0,
        attendance: {}
      };
      
      // Initialize results
      options.forEach((_, index) => {
        poll.results[index] = 0;
      });
      
      // Send poll to other participants
      ws.send(JSON.stringify({
        type: 'poll-created',
        poll: poll
      }));
      
      // Store current poll
      currentPoll = poll;
      pollResultsData = {};
      attendanceRecords = {};
      isPollCreator = true;
      
      // Close poll creator
      closePollCreator();
      
      // Display the poll for the creator
      displayPoll(poll);
    }
    
    function displayPoll(poll) {
      activePollQuestion.textContent = poll.question;
      pollOptionsList.innerHTML = '';
      pollResults.style.display = 'none';
      
      // Create option buttons
      poll.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'poll-option-item';
        
        const isCorrectOption = index === poll.correctAnswer;
        const buttonClass = isCorrectOption && isPollCreator ? 'correct' : '';
        
        optionDiv.innerHTML = `
          <button class="poll-option-button ${buttonClass}" data-index="${index}">${option}</button>
        `;
        pollOptionsList.appendChild(optionDiv);
      });
      
      // Add event listeners to option buttons
      const optionButtons = pollOptionsList.querySelectorAll('.poll-option-button');
      optionButtons.forEach(button => {
        button.addEventListener('click', function() {
          if (userVote !== null) return; // Prevent voting twice
          
          const optionIndex = parseInt(this.getAttribute('data-index'));
          voteInPoll(poll.id, optionIndex);
          
          // Highlight selected option
          optionButtons.forEach(btn => btn.classList.remove('selected'));
          this.classList.add('selected');
          
          userVote = optionIndex;
          
          // Check if the answer is correct
          const isCorrect = optionIndex === poll.correctAnswer;
          
          // Mark attendance if answer is correct
          if (isCorrect) {
            const participantName = participants.get(ws.participantId) || 'Participant';
            
            // Send attendance message
            ws.send(JSON.stringify({
              type: 'attendance-marked',
              participantId: ws.participantId,
              participantName: participantName,
              correct: true
            }));
            
            // Update UI
            showAttendanceMessage(participantName);
          }
        });
      });
      
      // Show the active poll
      activePoll.style.display = 'block';
      currentPoll = poll;
    }
    
    function voteInPoll(pollId, optionIndex) {
      const participantName = participants.get(ws.participantId) || 'Participant';
      
      // Send vote to other participants
      ws.send(JSON.stringify({
        type: 'poll-vote',
        pollId: pollId,
        optionIndex: optionIndex,
        participantName: participantName
      }));
      
      // Update local results
      updatePollResults(pollId, optionIndex, ws.participantId, participantName);
    }
    
    function updatePollResults(pollId, optionIndex, participantId, participantName) {
      if (currentPoll && currentPoll.id === pollId) {
        // Store participant's vote
        pollResultsData[participantId] = {
          optionIndex: optionIndex,
          participantName: participantName
        };
        
        // Update results count
        currentPoll.results[optionIndex]++;
        currentPoll.totalVotes++;
        
        // Show results if user has voted
        if (userVote !== null) {
          showPollResults();
        }
        
        // Update overall results display
        updateResultsContainer();
      }
    }
    
    function updateAttendanceRecords(participantId, participantName, correct) {
      if (!currentPoll) return;
      
      if (!currentPoll.attendance[participantId]) {
        currentPoll.attendance[participantId] = {
          name: participantName,
          correct: correct
        };
        
        // Update results if we're the poll creator
        if (isPollCreator) {
          updateResultsContainer();
        }
      }
    }
    
    function showPollResults() {
      if (!currentPoll) return;
      
      pollResults.style.display = 'block';
      
      let resultsHTML = '';
      currentPoll.options.forEach((option, index) => {
        const voteCount = currentPoll.results[index];
        const percentage = currentPoll.totalVotes > 0 
          ? Math.round((voteCount / currentPoll.totalVotes) * 100) 
          : 0;
        
        // Highlight correct answer if user is the poll creator
        const isCorrect = index === currentPoll.correctAnswer;
        const highlightClass = isCorrect && isPollCreator ? 'correct-indicator' : '';
        
        resultsHTML += `
          <div class="poll-result-item">
            <div class="${highlightClass}">${option} ${isCorrect && isPollCreator ? '✓' : ''}</div>
            <div class="poll-result-bar">
              <div class="poll-result-fill" style="width: ${percentage}%"></div>
            </div>
            <div class="poll-result-text">
              <span>${voteCount} vote${voteCount !== 1 ? 's' : ''}</span>
              <span>${percentage}%</span>
            </div>
          </div>
        `;
      });
      
      pollResults.innerHTML = resultsHTML;
      pollResultText.textContent = `Total votes: ${currentPoll.totalVotes}`;
    }
    
    function showAttendanceMessage(participantName) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'attendance-message';
      messageDiv.innerHTML = `
        <i class="fas fa-check-circle"></i> Attendance has been marked for ${participantName}
      `;
      
      // Add to active poll
      activePoll.appendChild(messageDiv);
      
      // Remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }
    
    function updateResultsContainer() {
      if (!currentPoll) return;
      
      resultsContainer.innerHTML = '';
      
      const summary = document.createElement('div');
      summary.className = 'results-summary';
      summary.innerHTML = `
        <h3>${currentPoll.question}</h3>
        <p>Total votes: ${currentPoll.totalVotes}</p>
      `;
      
      resultsContainer.appendChild(summary);
      
      // Show detailed results if user is the poll creator
      if (isPollCreator) {
        // Show attendance records
        const attendanceDiv = document.createElement('div');
        attendanceDiv.className = 'attendance-list';
        attendanceDiv.innerHTML = '<h4>Attendance Records:</h4>';
        
        const attendanceList = document.createElement('div');
        attendanceList.className = 'attendance-items';
        
        // Add each participant's attendance status
        participants.forEach((name, id) => {
          const attendanceItem = document.createElement('div');
          attendanceItem.className = 'attendance-item';
          
          const attendanceStatus = currentPoll.attendance[id] || { correct: false };
          const statusText = attendanceStatus.correct ? 
            '<span class="correct-indicator">✓ Present</span>' : 
            '<span class="text-muted">Not marked</span>';
          
          attendanceItem.innerHTML = `
            <span>${name}</span>
            ${statusText}
          `;
          
          attendanceList.appendChild(attendanceItem);
        });
        
        attendanceDiv.appendChild(attendanceList);
        resultsContainer.appendChild(attendanceDiv);
        
        // Show voting results
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'poll-results';
        resultsDiv.style.marginTop = '15px';
        
        let resultsHTML = '<h4>Voting Results:</h4>';
        currentPoll.options.forEach((option, index) => {
          const voteCount = currentPoll.results[index];
          const percentage = currentPoll.totalVotes > 0 
            ? Math.round((voteCount / currentPoll.totalVotes) * 100) 
            : 0;
          
          // Highlight correct answer
          const isCorrect = index === currentPoll.correctAnswer;
          const highlightClass = isCorrect ? 'correct-indicator' : '';
          
          resultsHTML += `
            <div class="poll-result-item">
              <div class="${highlightClass}">${option} ${isCorrect ? '✓' : ''}</div>
              <div class="poll-result-bar">
                <div class="poll-result-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="poll-result-text">
                <span>${voteCount} vote${voteCount !== 1 ? 's' : ''}</span>
                <span>${percentage}%</span>
              </div>
            </div>
          `;
        });
        
        resultsDiv.innerHTML = resultsHTML;
        resultsContainer.appendChild(resultsDiv);
      } else {
        // For regular participants, just show their attendance status
        const participantName = participants.get(ws.participantId) || 'Participant';
        const attendanceStatus = currentPoll.attendance[ws.participantId] || { correct: false };
        
        if (attendanceStatus.correct) {
          const results = document.createElement('div');
          results.innerHTML = `
            <div class="attendance-message">
              <i class="fas fa-check-circle"></i> Attendance has been marked for ${participantName}
            </div>
          `;
          resultsContainer.appendChild(results);
        }
      }
    }
    
    function endPoll(pollId, finalResults) {
      if (currentPoll && currentPoll.id === pollId) {
        currentPoll.results = finalResults;
        currentPoll.totalVotes = Object.values(finalResults).reduce((sum, count) => sum + count, 0);
        
        showPollResults();
        
        // Add a ended message
        const endedText = document.createElement('div');
        endedText.style.marginTop = '10px';
        endedText.style.fontWeight = 'bold';
        endedText.style.color = '#dc3545';
        endedText.textContent = 'Poll ended';
        pollResults.appendChild(endedText);
      }
    }
    
    function closeActivePoll() {
      activePoll.style.display = 'none';
      currentPoll = null;
      userVote = null;
      isPollCreator = false;
    }
    
    function resetPoll() {
      currentPoll = null;
      userVote = null;
      pollResultsData = {};
      attendanceRecords = {};
      isPollCreator = false;
      
      resultsContainer.innerHTML = '<p>No poll results yet. Create a poll to see results here.</p>';
      
      if (activePoll.style.display === 'block') {
        closeActivePoll();
      }
    }
    
    // Initialize the application when the page loads
    window.addEventListener('load', function() {
      setupEventListeners();
      updateConnectionStatus('connecting');
      
      // Set default participant name
      participantNameInput.value = 'Participant ' + Math.floor(Math.random() * 1000);
      updateParticipantName();
      
      // Simulate receiving a participant join message
      setTimeout(() => {
        ws.send(JSON.stringify({
          type: 'participant-joined',
          participantId: ws.participantId,
          participantName: participantNameInput.value
        }));
      }, 1000);
    });
  </script>
</body>
</html>