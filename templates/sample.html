<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Video Call</title>
<style>
body { font-family: sans-serif; background: #121212; color: white; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh;}
video { width: 300px; height: 225px; background:black; margin: 10px; border-radius:8px; object-fit:cover; }
button { padding:10px 20px; margin:5px; cursor:pointer; }
</style>
</head>
<body>
<h2>Video Call</h2>
<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>
<div>
<button id="startBtn">Start Camera</button>
<button id="callBtn">Call</button>
</div>

<script>
let localStream, pc;
const ws = new WebSocket("ws://localhost:8080/ws");

// STUN server
const config = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);
    console.log(msg)

    if(msg.type === "offer") {
        if(pc.signalingState !== "stable") return; 
        await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "answer", data: answer }));
        console.log("Sent answer:", answer);
    } else if(msg.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
        console.log("Set remote answer");
    } else if(msg.type === "candidate") {
        try {
            await pc.addIceCandidate(msg.data);
            console.log("Added remote candidate:", msg.data);
        } catch(e) {
            console.error("Error adding candidate:", e);
        }
    }
};

document.getElementById('startBtn').onclick = async () => {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    document.getElementById('localVideo').srcObject = localStream;

    pc = new RTCPeerConnection(config);
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

    pc.onicecandidate = e => {
        if(e.candidate) {
            ws.send(JSON.stringify({ type: "candidate", data: e.candidate }));
            console.log("Sending candidate:", e.candidate);
        }
    };
};

document.getElementById('callBtn').onclick = async () => {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ type: "offer", data: offer }));
    console.log("Sending offer:", offer);
};
</script>
</body>
</html>
